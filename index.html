<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DeFlo App</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      /* Reset and basic styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        min-height: 100vh;
      }
      /* Top Bar */
      .top-bar {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
        position: relative;
        background-color: #042d42;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 0 20px;
      }
      .app-name {
        font-size: 3em;
        font-weight: bold;
        color: #62d74e;
      }
      .profile-container {
        position: absolute;
        right: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
      }
      .profile-text {
        margin-right: 10px;
        color: #fff;
        font-size: 1em;
      }
      .profile-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        color: #fff;
      }
      /* Dropdown menu */
      .dropdown {
        position: absolute;
        top: 60px;
        right: 20px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .dropdown a {
        display: block;
        padding: 10px 15px;
        text-decoration: none;
        color: #333;
      }
      .dropdown a:hover {
        background: #f0f0f0;
      }
      /* Floating Button */
      .floating-button {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #042d42;
        color: #62d74e;
        border: none;
        font-size: 2em;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      /* Modal Styles (shared by Create and Edit) */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal-box {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 500px;
        padding: 20px;
      }
      .modal-box h2 {
        text-align: center;
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
      }
      label.required::after {
        content: " *";
        color: red;
      }
      .form-group label {
        margin-bottom: 5px;
        font-weight: bold;
        font-size: 0.9em;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 0.9em;
      }
      /* Date fields side by side */
      .date-group {
        display: flex;
        gap: 10px;
      }
      .date-group .form-group {
        flex: 1;
      }
      /* Group Priority and Status side by side in Edit modal */
      .priority-status-group {
        display: flex;
        gap: 10px;
      }
      .priority-status-group .form-group {
        flex: 1;
      }
      .button-group {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      /* Button styles */
      .save-btn,
      .edit-btn {
        background: #042d42;
        color: #62d74e;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .cancel-btn,
      .delete-btn {
        background: #dddddd;
        color: black;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      /* Active filter button for status */
      .status-filters button.active {
        background: #042d42;
        color: #62d74e;
      }
      /* Active priority filter styling on dropdown items */
      .dropdown-sort.priority-dropdown .dropdown-sort-content a.active {
        background: #042d42;
        color: #62d74e;
      }
      /* Active sort button styling */
      .priority-sort button.active {
        background: #042d42;
        color: #62d74e;
      }
      /* Export Button styling */
      #exportButton {
        display: none;
        margin: 20px auto 0;
        padding: 10px 20px;
        background: #042d42;
        color: #62d74e;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
      }
      /* Search Bar styling */
      .search-bar {
        width: 60%;
        display: block;
        margin: 0 auto 20px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 20px;
        font-size: 0.9em;
      }
      /* Filter Message styling */
      #filterMessage {
        text-align: center;
        padding: 20px;
        color: #666;
        font-size: 1.1em;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 20px;
        background: #fff;
      }
      /* Motivational Message */
      #noTaskMessage {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: calc(100vh - 100px);
        text-align: center;
        font-size: 1.1em;
        color: #666;
        padding: 20px;
      }
      /* Task List Container */
      .task-list-container {
        width: 50%;
        margin: 20px auto;
        background: #ffffff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
      }
      /* Task List Controls */
      .task-list-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .status-filters button,
      .priority-sort button {
        padding: 8px 12px;
        margin-right: 5px;
        border: 1px solid #ccc;
        background: #fff;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.9em;
      }
      .status-filters button:last-child {
        margin-right: 0;
      }
      .priority-sort {
        display: flex;
        align-items: center;
      }
      .priority-sort button {
        margin-right: 5px;
      }
      /* Dropdown for Sort and Priority filters */
      .dropdown-sort {
        position: relative;
        display: inline-block;
      }
      .dropdown-sort-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: #fff;
        border: 1px solid #ccc;
        border-radius: 4px;
        min-width: 150px;
        z-index: 10;
      }
      .dropdown-sort-content a {
        color: #333;
        padding: 8px 12px;
        text-decoration: none;
        display: block;
        font-size: 0.9em;
      }
      .dropdown-sort-content a:hover {
        background-color: #f0f0f0;
      }
      .dropdown-sort:hover .dropdown-sort-content {
        display: block;
      }
      /* Task Item */
      .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
      }
      .task-item:last-child {
        border-bottom: none;
      }
      .task-title {
        font-weight: bold;
        font-size: 1em;
        flex: 1;
        text-align: left;
      }
      .task-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      /* Fixed width for status container */
      .task-actions .status {
        font-size: 0.9em;
        margin-right: 10px;
        width: 120px;
        text-align: center;
      }
      /* Lighter text for completed tasks */
      .task-item.completed .task-title {
        text-decoration: line-through;
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="app-name">DeFlo</div>
      <div class="profile-container" id="profile">
        <span class="profile-text">Hi Pavan</span>
        <div class="profile-avatar">
          <i class="fa-solid fa-circle-user"></i>
        </div>
        <div class="dropdown" id="dropdown">
          <a href="#" id="logout">Logout</a>
        </div>
      </div>
    </div>

    <!-- Floating "+" Button -->
    <button class="floating-button" id="addButton">+</button>

    <!-- Create Task Modal -->
    <div class="modal-overlay" id="taskModal">
      <div class="modal-box">
        <h2>Create a Task</h2>
        <form id="taskForm">
          <div class="form-group">
            <label for="title" class="required">Title</label>
            <input type="text" id="title" placeholder="Title" required />
          </div>
          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" placeholder="Description"></textarea>
          </div>
          <div class="date-group">
            <div class="form-group">
              <label for="startDate" class="required">Start Date</label>
              <input type="date" id="startDate" required />
            </div>
            <div class="form-group">
              <label for="endDate" class="required">End Date</label>
              <input type="date" id="endDate" required />
            </div>
          </div>
          <div class="form-group">
            <label for="priority" class="required">Priority Level</label>
            <select id="priority" required>
              <option value="" disabled selected hidden>Select Priority</option>
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>
          <div class="button-group">
            <button type="button" class="cancel-btn" id="cancelModal">
              Cancel
            </button>
            <button type="submit" class="save-btn">Add Task</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal-overlay" id="editTaskModal">
      <div class="modal-box">
        <h2 id="editModalHeading">Edit Task</h2>
        <form id="editTaskForm">
          <div class="form-group">
            <label for="editTitle" class="required">Title</label>
            <input type="text" id="editTitle" required />
          </div>
          <div class="form-group">
            <label for="editDescription">Description</label>
            <textarea id="editDescription"></textarea>
          </div>
          <div class="date-group">
            <div class="form-group">
              <label for="editStartDate" class="required">Start Date</label>
              <input type="date" id="editStartDate" required />
            </div>
            <div class="form-group">
              <label for="editEndDate" class="required">End Date</label>
              <input type="date" id="editEndDate" required />
            </div>
          </div>
          <div class="priority-status-group">
            <div class="form-group">
              <label for="editPriority" class="required">Priority Level</label>
              <select id="editPriority" required>
                <option value="" disabled selected hidden>
                  Select Priority
                </option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editStatus" class="required">Status</label>
              <select id="editStatus" required>
                <option value="" disabled selected hidden>Select Status</option>
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
          </div>
          <div class="button-group">
            <button type="button" class="cancel-btn" id="cancelEditModal">
              Cancel
            </button>
            <button type="submit" class="edit-btn">Edit</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Motivational Message Container (shown only when no tasks exist) -->
    <div id="noTaskMessage">
      <h2>Let's create your first task!</h2>
      <p>Stay organized and get things done.</p>
    </div>

    <!-- Task List Container (hidden initially) -->
    <div
      class="task-list-container"
      id="taskListContainer"
      style="display: none"
    >
      <!-- Search Bar -->
      <input
        type="search"
        id="searchBar"
        class="search-bar"
        placeholder="Search tasks..."
      />
      <div class="task-list-controls">
        <div class="status-filters">
          <button type="button" data-filter="all">All</button>
          <button type="button" data-filter="Pending">Pending</button>
          <button type="button" data-filter="In Progress">In Progress</button>
          <button type="button" data-filter="Completed">Completed</button>
        </div>
        <div class="priority-sort">
          <!-- Priority Filter Dropdown -->
          <div class="dropdown-sort priority-dropdown">
            <button type="button" id="priorityButton">
              Priority <i class="fa-solid fa-caret-down"></i>
            </button>
            <div class="dropdown-sort-content">
              <a href="#" data-priority="High">High</a>
              <a href="#" data-priority="Medium">Medium</a>
              <a href="#" data-priority="Low">Low</a>
            </div>
          </div>
          <!-- Sort Dropdown -->
          <div class="dropdown-sort">
            <button type="button" id="sortButton">
              Sort <i class="fa-solid fa-caret-down"></i>
            </button>
            <div class="dropdown-sort-content">
              <a href="#" data-sort="start">Start Date</a>
              <a href="#" data-sort="end">End Date</a>
              <a href="#" data-sort="created">Created Date</a>
              <a href="#" data-sort="modified">Last Modified</a>
            </div>
          </div>
        </div>
      </div>
      <!-- Filter Message -->
      <div id="filterMessage" style="display: none">
        No tasks found matching your filters.
      </div>
      <div class="task-items" id="taskItems">
        <!-- Task items will be appended here -->
      </div>
      <!-- Export Button -->
      <button id="exportButton">Export All</button>
    </div>

    <script>
      // IndexedDB Setup
      let db;
      const request = indexedDB.open("DeFloDB", 1);
      request.onupgradeneeded = function (event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains("tasks")) {
          db.createObjectStore("tasks", { keyPath: "id", autoIncrement: true });
        }
      };
      request.onsuccess = function (event) {
        db = event.target.result;
        loadTasksFromDB();
      };
      request.onerror = function (event) {
        console.error("IndexedDB error:", event.target.errorCode);
      };

      // Global filter variables
      let activeStatus = "all"; // "all", "Pending", "In Progress", "Completed"
      let activePriority = ""; // empty string means no filter

      // Toggle profile dropdown
      const profile = document.getElementById("profile");
      const dropdown = document.getElementById("dropdown");
      profile.addEventListener("click", function (event) {
        event.stopPropagation();
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      });
      document.addEventListener("click", function () {
        if (dropdown.style.display === "block") {
          dropdown.style.display = "none";
        }
      });

      // Open Create Task Modal
      const addButton = document.getElementById("addButton");
      const taskModal = document.getElementById("taskModal");
      const cancelModal = document.getElementById("cancelModal");
      addButton.addEventListener("click", function () {
        taskModal.style.display = "flex";
      });
      cancelModal.addEventListener("click", function () {
        taskModal.style.display = "none";
      });

      // Function to convert priority text to emoji
      function getPriorityEmoji(priority) {
        switch (priority) {
          case "High":
            return "ðŸ”´";
          case "Medium":
            return "ðŸŸ¡";
          case "Low":
            return "ðŸŸ¢";
          default:
            return "";
        }
      }

      // Create a DOM element for a task
      function createTaskElement(task) {
        const taskItem = document.createElement("div");
        taskItem.className = "task-item";
        taskItem.dataset.id = task.id;
        taskItem.dataset.title = task.title;
        taskItem.dataset.description = task.description;
        taskItem.dataset.startDate = task.startDate;
        taskItem.dataset.endDate = task.endDate;
        taskItem.dataset.priority = task.priority;
        taskItem.dataset.status = task.status;
        taskItem.dataset.created = task.created;
        taskItem.dataset.modified = task.modified;
        taskItem.innerHTML = `
        <div class="task-title">${task.title}</div>
        <div class="task-actions">
          <div class="priority" title="${task.priority}">${getPriorityEmoji(
          task.priority
        )}</div>
          <div class="status">${task.status}</div>
          <button type="button" class="edit-btn"><i class="fa-solid fa-edit"></i> Edit</button>
          <button type="button" class="delete-btn"><i class="fa-solid fa-trash"></i> Delete</button>
        </div>
      `;
        if (task.status === "Completed" && activeStatus === "all") {
          taskItem.classList.add("completed");
        }
        return taskItem;
      }

      // Load tasks from IndexedDB
      function loadTasksFromDB() {
        const transaction = db.transaction(["tasks"], "readonly");
        const store = transaction.objectStore("tasks");
        const requestAll = store.getAll();
        requestAll.onsuccess = function (event) {
          const tasks = event.target.result;
          const taskItems = document.getElementById("taskItems");
          taskItems.innerHTML = "";
          tasks.forEach((task) => {
            const taskEl = createTaskElement(task);
            taskItems.appendChild(taskEl);
          });
          applyFilters();
          updateTaskView();
        };
      }

      // Add task to IndexedDB
      function addTaskToDB(task) {
        const transaction = db.transaction(["tasks"], "readwrite");
        const store = transaction.objectStore("tasks");
        const addRequest = store.add(task);
        addRequest.onsuccess = function (event) {
          task.id = event.target.result;
          const taskEl = createTaskElement(task);
          document.getElementById("taskItems").appendChild(taskEl);
          applyFilters();
          updateTaskView();
        };
      }

      // Update task in IndexedDB
      function updateTaskInDB(task) {
        const transaction = db.transaction(["tasks"], "readwrite");
        const store = transaction.objectStore("tasks");
        store.put(task);
      }

      // Delete task from IndexedDB
      function deleteTaskFromDB(taskId) {
        const transaction = db.transaction(["tasks"], "readwrite");
        const store = transaction.objectStore("tasks");
        store.delete(Number(taskId));
      }

      // Apply filters (status, priority, search term)
      function applyFilters() {
        const tasks = document.querySelectorAll("#taskItems .task-item");
        const searchTerm = document
          .getElementById("searchBar")
          .value.trim()
          .toLowerCase();
        let visibleCount = 0;
        tasks.forEach((task) => {
          const statusMatch =
            activeStatus === "all" || task.dataset.status === activeStatus;
          const priorityMatch =
            activePriority === "" || task.dataset.priority === activePriority;
          const searchMatch =
            task.dataset.title.toLowerCase().includes(searchTerm) ||
            task.dataset.description.toLowerCase().includes(searchTerm);
          if (statusMatch && priorityMatch && searchMatch) {
            task.style.display = "flex";
            if (activePriority !== "") {
              task.querySelector(".priority").textContent = "";
            } else {
              task.querySelector(".priority").textContent = getPriorityEmoji(
                task.dataset.priority
              );
            }
            if (activeStatus === "all") {
              task.querySelector(".status").style.display = "block";
              if (task.dataset.status === "Completed")
                task.classList.add("completed");
              else task.classList.remove("completed");
            } else {
              task.querySelector(".status").style.display = "none";
              task.classList.remove("completed");
            }
            visibleCount++;
          } else {
            task.style.display = "none";
          }
        });
        const filterMessage = document.getElementById("filterMessage");
        if (
          document.getElementById("taskItems").children.length > 0 &&
          visibleCount === 0
        ) {
          filterMessage.style.display = "block";
        } else {
          filterMessage.style.display = "none";
        }
        updateExportButton(visibleCount);
      }

      // Update Export Button based on visible tasks
      function updateExportButton(visibleCount) {
        const exportButton = document.getElementById("exportButton");
        if (
          document.getElementById("taskItems").children.length === 0 ||
          visibleCount === 0
        ) {
          exportButton.style.display = "none";
        } else {
          exportButton.style.display = "block";
          if (
            activeStatus === "all" &&
            activePriority === "" &&
            document.getElementById("searchBar").value.trim() === ""
          ) {
            exportButton.textContent = "Export All";
          } else {
            exportButton.textContent = "Export";
          }
        }
      }

      // Update view based on task count
      function updateTaskView() {
        const taskItems = document.getElementById("taskItems");
        const noTaskMessage = document.getElementById("noTaskMessage");
        const taskListContainer = document.getElementById("taskListContainer");
        if (taskItems.children.length === 0) {
          noTaskMessage.style.display = "flex";
          taskListContainer.style.display = "none";
        } else {
          noTaskMessage.style.display = "none";
          taskListContainer.style.display = "block";
        }
      }

      // Create Task form submission
      const taskForm = document.getElementById("taskForm");
      taskForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const title = document.getElementById("title").value.trim();
        const description = document.getElementById("description").value.trim();
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        const priority = document.getElementById("priority").value;
        const status = "Pending";
        const now = Date.now();
        const task = {
          title,
          description,
          startDate,
          endDate,
          priority,
          status,
          created: now,
          modified: now,
        };
        addTaskToDB(task);
        taskForm.reset();
        taskModal.style.display = "none";
      });

      // Edit Task functionality
      let currentEditingTask = null;
      document
        .getElementById("taskItems")
        .addEventListener("click", function (e) {
          if (e.target.closest(".edit-btn")) {
            const taskItem = e.target.closest(".task-item");
            currentEditingTask = taskItem;
            document.getElementById("editTitle").value = taskItem.dataset.title;
            document.getElementById("editDescription").value =
              taskItem.dataset.description;
            document.getElementById("editStartDate").value =
              taskItem.dataset.startDate;
            document.getElementById("editEndDate").value =
              taskItem.dataset.endDate;
            document.getElementById("editPriority").value =
              taskItem.dataset.priority;
            document.getElementById("editStatus").value =
              taskItem.dataset.status;
            document.getElementById("editModalHeading").textContent =
              taskItem.dataset.title;
            document.getElementById("editTaskModal").style.display = "flex";
          }
        });

      // Handle Edit Task form submission
      document
        .getElementById("editTaskForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          if (currentEditingTask) {
            const newTitle = document.getElementById("editTitle").value.trim();
            const newDescription = document
              .getElementById("editDescription")
              .value.trim();
            const newStartDate = document.getElementById("editStartDate").value;
            const newEndDate = document.getElementById("editEndDate").value;
            const newPriority = document.getElementById("editPriority").value;
            const newStatus = document.getElementById("editStatus").value;
            currentEditingTask.dataset.title = newTitle;
            currentEditingTask.dataset.description = newDescription;
            currentEditingTask.dataset.startDate = newStartDate;
            currentEditingTask.dataset.endDate = newEndDate;
            currentEditingTask.dataset.priority = newPriority;
            currentEditingTask.dataset.status = newStatus;
            currentEditingTask.dataset.modified = Date.now();
            currentEditingTask.querySelector(".task-title").textContent =
              newTitle;
            currentEditingTask.querySelector(".priority").textContent =
              getPriorityEmoji(newPriority);
            currentEditingTask.querySelector(".priority").title = newPriority;
            currentEditingTask.querySelector(".status").textContent = newStatus;
            // Update in IndexedDB
            const updatedTask = {
              id: Number(currentEditingTask.dataset.id),
              title: newTitle,
              description: newDescription,
              startDate: newStartDate,
              endDate: newEndDate,
              priority: newPriority,
              status: newStatus,
              created: Number(currentEditingTask.dataset.created),
              modified: Number(currentEditingTask.dataset.modified),
            };
            updateTaskInDB(updatedTask);
            document.getElementById("editTaskModal").style.display = "none";
            applyFilters();
          }
        });

      // Cancel Edit Task Modal
      document
        .getElementById("cancelEditModal")
        .addEventListener("click", function () {
          document.getElementById("editTaskModal").style.display = "none";
        });

      // Delete Task functionality
      document
        .getElementById("taskItems")
        .addEventListener("click", function (e) {
          if (e.target.closest(".delete-btn")) {
            const taskItem = e.target.closest(".task-item");
            deleteTaskFromDB(taskItem.dataset.id);
            taskItem.remove();
            updateTaskView();
          }
        });

      // Logout click event
      const logout = document.getElementById("logout");
      logout.addEventListener("click", function (e) {
        e.preventDefault();
        alert("Logout functionality here!");
      });

      // Status filter event listener
      document.querySelectorAll(".status-filters button").forEach((btn) => {
        btn.addEventListener("click", function () {
          if (this.classList.contains("active")) {
            activeStatus = "all";
            document
              .querySelectorAll(".status-filters button")
              .forEach((b) => b.classList.remove("active"));
            document
              .querySelector('.status-filters button[data-filter="all"]')
              .classList.add("active");
          } else {
            activeStatus = this.dataset.filter;
            document
              .querySelectorAll(".status-filters button")
              .forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
          }
          applyFilters();
        });
      });
      activeStatus = "all";
      document
        .querySelector('.status-filters button[data-filter="all"]')
        .classList.add("active");

      // Priority filter event listener (dropdown)
      document
        .querySelectorAll(
          ".dropdown-sort.priority-dropdown .dropdown-sort-content a[data-priority]"
        )
        .forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const filterPriority = this.dataset.priority;
            const priorityButton =
              this.closest(".dropdown-sort").querySelector("button");
            if (this.classList.contains("active")) {
              this.classList.remove("active");
              activePriority = "";
              priorityButton.innerHTML =
                "Priority <i class='fa-solid fa-caret-down'></i>";
              priorityButton.classList.remove("active");
              applyFilters();
              return;
            }
            document
              .querySelectorAll(
                ".dropdown-sort.priority-dropdown .dropdown-sort-content a[data-priority]"
              )
              .forEach((a) => a.classList.remove("active"));
            this.classList.add("active");
            activePriority = filterPriority;
            priorityButton.innerHTML =
              this.textContent + " <i class='fa-solid fa-caret-down'></i>";
            priorityButton.classList.add("active");
            applyFilters();
          });
        });

      // Sorting functionality for sort dropdown
      document
        .querySelectorAll(
          ".dropdown-sort:not(.priority-dropdown) .dropdown-sort-content a[data-sort]"
        )
        .forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const sortType = this.dataset.sort;
            const sortButton =
              this.closest(".dropdown-sort").querySelector("button");
            if (this.classList.contains("active")) {
              this.classList.remove("active");
              sortButton.innerHTML =
                "Sort <i class='fa-solid fa-caret-down'></i>";
              sortButton.classList.remove("active");
              const tasksContainer = document.getElementById("taskItems");
              const tasks = Array.from(tasksContainer.children);
              tasks.sort(
                (a, b) => Number(a.dataset.created) - Number(b.dataset.created)
              );
              tasks.forEach((task) => tasksContainer.appendChild(task));
              return;
            }
            document
              .querySelectorAll(
                ".dropdown-sort:not(.priority-dropdown) .dropdown-sort-content a[data-sort]"
              )
              .forEach((a) => a.classList.remove("active"));
            this.classList.add("active");
            sortButton.innerHTML =
              this.textContent + " <i class='fa-solid fa-caret-down'></i>";
            sortButton.classList.add("active");
            const tasksContainer = document.getElementById("taskItems");
            const tasks = Array.from(tasksContainer.children);
            tasks.sort((a, b) => {
              if (sortType === "start") {
                return a.dataset.startDate.localeCompare(b.dataset.startDate);
              } else if (sortType === "end") {
                return a.dataset.endDate.localeCompare(b.dataset.endDate);
              } else if (sortType === "created") {
                return Number(a.dataset.created) - Number(b.dataset.created);
              } else if (sortType === "modified") {
                return Number(a.dataset.modified) - Number(b.dataset.modified);
              }
            });
            tasks.forEach((task) => tasksContainer.appendChild(task));
          });
        });

      // Search bar event listener
      document
        .getElementById("searchBar")
        .addEventListener("input", function () {
          applyFilters();
        });

      // Export functionality: Export tasks to CSV
      document
        .getElementById("exportButton")
        .addEventListener("click", function () {
          const exportAll = this.textContent.trim() === "Export All";
          const tasks = document.querySelectorAll("#taskItems .task-item");
          let data =
            "Title,Description,Start Date,End Date,Priority,Status,Created,Modified\n";
          tasks.forEach((task) => {
            if (exportAll || task.style.display !== "none") {
              const title = `"${task.dataset.title}"`;
              const description = `"${task.dataset.description}"`;
              const startDate = task.dataset.startDate;
              const endDate = task.dataset.endDate;
              const priority = task.dataset.priority;
              const status = task.dataset.status;
              const created = task.dataset.created;
              const modified = task.dataset.modified;
              data += `${title},${description},${startDate},${endDate},${priority},${status},${created},${modified}\n`;
            }
          });
          const blob = new Blob([data], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "tasks.csv";
          a.style.display = "none";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });

      // Initial view update
      updateTaskView();
    </script>
  </body>
</html>
